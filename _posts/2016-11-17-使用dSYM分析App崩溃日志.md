---
layout: post
title: ä½¿ç”¨dSYMåˆ†æAppå´©æºƒæ—¥å¿—
date: 2016-11-17 23:19:12
tags: "iOS"
---

<!--more-->

## å‰è¨€
æˆ‘ä»¬åœ¨å¼€å‘Appè¿‡ç¨‹ä¸­ï¼Œå› ä¸ºè¿æ¥åˆ°æ§åˆ¶å°ï¼Œæ‰€ä»¥é‡åˆ°é—®é¢˜ä¼šå¾ˆå®¹æ˜“æ‰¾åˆ°é—®é¢˜ä»£ç ã€‚ä½†æ˜¯å¯¹äºçº¿ä¸Šçš„Appå‡ºç°Crashçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¯èƒ½é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¹Ÿä¸ç°å®ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½é€šè¿‡æ”¶é›†Crashä¿¡æ¯ï¼Œæ¥è§£å†³Bugã€‚è€Œè¿™ç§æ”¶é›†Crashä¿¡æ¯å¹¶ä¸”åˆ†æå®šä½åˆ°å…·ä½“ä»£ç çš„ç¬¬ä¸‰æ–¹SDKå¾ˆå¤šã€‚ä½†æ˜¯ä»Šå¤©æˆ‘ä»¬æ¥è‡ªå·±å®ç°ä¸€ä¸‹ã€‚

<!--more-->

## æ”¶é›† Crash ä¿¡æ¯
`Apple`æä¾›äº†`NSException`ç±»æ¥å¸®åŠ©æˆ‘ä»¬æ”¶é›†å¼‚å¸¸ä¿¡æ¯ã€‚

> NSException is used to implement exception handling and contains information about an exception  â€” Apple Documentation.

[ç‚¹å‡»è¿™é‡Œ](https://developer.apple.com/reference/foundation/nsexception)æ¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£å…·ä½“å†…å®¹ã€‚

æˆ‘ä»¬çš„ç¡®å¯ä»¥é€šè¿‡`NSException`æ¥æ”¶é›†ä¿¡æ¯ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬æ€ä¹ˆæŠŠè¿™ä¸ªä¿¡æ¯ä¿å­˜ä¸‹æ¥ï¼Œå¹¶ä¸”ä¸Šä¼ åˆ°æˆ‘ä»¬åå°æœåŠ¡å™¨ï¼Œæ”¶é›†èµ·æ¥å‘¢ã€‚è¿™å°±éœ€è¦ç”¨åˆ°å¦ä¸€ä¸ªå‡½æ•°:`NSUncaughtExceptionHandler`

> Sets the top-level error-handling function where you can perform last-minute logging before the program terminates.

æ„æ€å°±æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨Appå¼‚å¸¸é€€å‡ºçš„ä¹‹å‰æœ‰ä¸€åˆ†é’Ÿçš„æ—¶é—´æ¥å¤„ç†å¼‚å¸¸ä¿¡æ¯ï¼Œåˆ©ç”¨è¿™æ®µæ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠCrashä¿¡æ¯å†™å…¥æœ¬åœ°ï¼Œä¹Ÿå¯ä»¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œä½†æ˜¯è€ƒè™‘åˆ°ç½‘ç»œé˜»å¡åŸå› ï¼Œæˆ‘ä»¬å¯èƒ½åœ¨è¿™ä¸€åˆ†é’Ÿä¸èƒ½æ“ä½œå®Œæ¯•ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠä¸Šä¼ æ”¾åˆ°ä¸‹ä¸€æ¬¡Appå¯åŠ¨æ—¶æ‰§è¡Œã€‚

å…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

``` ObjC
- (void)lyCarshLog {
    [self uploadExceptionLog];
    NSSetUncaughtExceptionHandler(&catchExceptionLog);
}
- (void)uploadExceptionLog {
     if (log != nil) {
        // åœ¨è¿™é‡Œä¸Šä¼  Crash ä¿¡æ¯ï¼Œä¸Šä¼ å®Œæ¯•åè¦è®°å¾—æ¸…ç©ºã€‚
     }
}
void catchExceptionLog(NSException *exception) {
    // è·å– Crash ä¿¡æ¯
    NSArray *symbols = [exception callStackSymbols];
    NSString *reason = [exception reason];
    NSString *name = [exception name];
    NSDictionary *userInfo = [exception userInfo];
    //...
    
    /*å¦å¤–ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä¸€äº›åˆ«çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´å‘ç”Ÿ Crash çš„è®¾å¤‡çš„ç³»ç»Ÿç‰ˆæœ¬ï¼Œè®¾å¤‡å‹å·ï¼ŒAppçš„ç‰ˆæœ¬å·*/
    struct utsname systemInfo; // éœ€è¦å¯¼å…¥`sys/utsname.h`å¤´æ–‡ä»¶ã€‚
    uname(&systemInfo);
    NSString *deviceString = [NSString stringWithCString:systemInfo.machine encoding:NSUTF8StringEncoding];
    NSDictionary *appInfo = [[NSBundle mainBundle] infoDictionary];
    NSString *appVersion = [appInfo objectForKey:@"CFBundleShortVersionString"];
    NSString *result = [NSString stringWithFormat:@"CarshReason = %@ \n name = %@ \n userInfo = %@ \n log = %@ \n systemVersion = %f \n deviceInfo = %@ \n appVersion = %@ ",reason,name,userInfo,symbols,[UIDevice currentDevice].systemVersion.floatValue,deviceString,appVersion];
    // æŠŠ result å†™å…¥æœ¬åœ°ã€‚
}

```

`Crash`ä¿¡æ¯è‡³æ­¤å·²ç»æ”¶é›†å®Œæ¯•ï¼Œç­‰å¾…ä¸‹æ¬¡Appå¯åŠ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŠŠæœ¬åœ°çš„Crashä¿¡æ¯ä¸Šä¼ åˆ°æœåŠ¡å™¨å°±OKäº†ã€‚

## å¤„ç† Crash ä¿¡æ¯ - ç¬¦å·åŒ–(Fully Symbolicated)

æˆ‘ä»¬å¾—åˆ°çš„ä¿¡æ¯å¯èƒ½å¦‚ä¸‹(Partially Symbolicated)ï¼š

> Tips: å †æ ˆè·Ÿè¸ªæ˜¯`è‡ªä¸‹è€Œä¸Š`å±•ç¤ºçš„ï¼Œä¹Ÿå°±æ˜¯æœ€å…ˆè°ƒç”¨çš„æ–¹æ³•åœ¨æœ€ä¸‹é¢ã€‚

æ¯è¡Œä¿¡æ¯ä¸­åŒ…å«çš„ä¿¡æ¯ï¼š


å…¶ä¸­ï¼š

1. `Binary name`  è¡¨æ˜ä»£ç æ‰€åœ¨`App`æˆ–è€…`Framework`çš„ä½ç½®ã€‚æ¯”å¦‚ï¼šline 0 æ˜¯åœ¨`CoreFoundation`ä¸­ï¼Œline 3 åœ¨`CrashDemo`ä¸­...
2. `Address` æ–¹æ³•çš„å†…å­˜åœ°å€ã€‚
3. `Class name` å½“å‰çš„ç±»åã€‚
4. `Method name` å½“å‰è°ƒç”¨çš„æ–¹æ³•åã€‚
5. `Offset` ç›¸å¯¹`åŠ è½½åœ°å€/åŸºåœ°å€(load address)`çš„åç§»é‡ã€‚

æˆ‘ä»¬å¾—åˆ°è¿™ä¸ªåŠç¬¦å·åŒ–(Partially Symbolicated)çš„æ—¥å¿—å¯¹æˆ‘ä»¬åˆ†æCrashåŸå› çš„å¸®åŠ©å¾ˆæœ‰é™ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½åªèƒ½çŸ¥é“`__NSArrayI objectAtIndex:`è°ƒç”¨å‡ºç°äº†é—®é¢˜ï¼Œä½†æ˜¯ä¸èƒ½å®šä½åˆ°å…·ä½“ä»£ç ã€‚æ‰€ä»¥æˆ‘ä»¬è¦æŠŠå®ƒå®Œå…¨ç¬¦å·åŒ–(Fully Symbolicated)ã€‚

### dSYM

æˆ‘ä»¬éœ€è¦å€ŸåŠ©`dSYM`æ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆç¬¦å·åŒ–ï¼Œå¯¹äº`dSYM`æ–‡ä»¶çš„è·å–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šç§æ–¹æ³•ï¼Œæˆ‘è¿™é‡Œåªè¯´ä¸€ç§:

å…ˆæ‰“å¼€`Xcode`ï¼Œ`Windows`->`Organize`->æ‰¾åˆ°å¯¹åº”çš„appåŒ…ï¼Œç„¶å`å³é”®`->`Show in finder`,æ‰¾åˆ°`appName. xcarchive `->`æ˜¾ç¤ºåŒ…å†…å®¹`->`æŠŠdSYMsæ‹·è´å‡ºæ¥(æˆ–è€…å°±åœ¨é‡Œé¢æ“ä½œ)`ã€‚

### atos

> The atos command converts numeric addresses to their symbolic equivalents

æˆ‘ä»¬ä½¿ç”¨`atos`å‘½ä»¤æ¥å®Œæˆç¬¦å·åŒ–ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š
`$ atos -arch <Binary Architecture> -o <Path to dSYM file>/Contents/Resources/DWARF/<binary image name> -l <load address> <address to symbolicate>
`
å…¶ä¸­:
1. Binary Architecture: `arm64`ã€`armv6`ã€`armv7` `armv7s` æ ¹æ®è‡ªå·±çš„æƒ…å†µæ¥å†™ã€‚
2. Path to dSYM file: dSYMæ–‡ä»¶çš„è·¯å¾„ã€‚
3. binary image name: ä½ å·¥ç¨‹çš„åå­—ã€‚
4. load address: åŸºåœ°å€ï¼Œå¦‚æœæˆ‘ä»¬çš„å´©æºƒæ—¥å¿—ä¸­æ²¡æœ‰è¿™ä¸ªä¿¡æ¯(æ¯”å¦‚ä¸Šé¢çš„Crashä¿¡æ¯ä¸­å°±æ²¡æœ‰åŒ…å«)ï¼Œå°±éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»è®¡ç®—è¿™ä¸ª`load address`:`laod address = address to symbolicate - offset`,æ¯”å¦‚ï¼š`0x0000000102838119`è½¬åŒ–ä¸ºåè¿›åˆ¶ä¸º`4337139993`,å†å‡å»åç§»é‡`265`,ä¸º`4337139728`,åœ¨è½¬åŒ–ä¸ºåå…­è¿›åˆ¶`0x0000000102838010`
5. address to symbolicate:å½“å‰æ–¹æ³•çš„å†…å­˜åœ°å€ã€‚

æ‰€ä»¥ï¼Œä¸Šå›¾ä¸ºä¾‹(å›¾è¢«é»‘å¿ƒå›¾åºŠåƒäº†ã€‚ã€‚ã€‚)ï¼š

```
$ cd CrashDemo/dSYMs
$ atos -arch arm64 -o CrashDemo.app.dSYM/Contents/Resources/DWARF/CrashDemo -l  0x0000000102838010 0x0000000102838119
```

è¿™æ—¶å‘½ä»¤å°±ä¼šè¾“å‡ºå·²ç»ç¬¦å·åŒ–è¿‡çš„ä¿¡æ¯:
`-[ViewController viewDidLoad] (in CrashDemo) (ViewController.m:45)`

å…¶ä¸­`45`å°±æ˜¯é—®é¢˜ä»£ç åœ¨`ViewController.m`ä¸­çš„å…·ä½“ä½ç½®ã€‚

å…¶å®`ç¬¦å·åŒ–`çš„è¿‡ç¨‹æœ‰å¤šç§æ–¹å¼ï¼Œä½ å¯ä»¥å‚è€ƒ[Appleæ–‡æ¡£](https://developer.apple.com/library/content/technotes/tn2151/_index.html),å¯¹äºå…¶ä¸­`UUID`ï¼Œåªæ˜¯ä¸ºäº†æˆ‘ä»¬æ‰¾åˆ°Appå¯¹åº”ç‰ˆæœ¬çš„`dSYM`æ–‡ä»¶ï¼Œæ‰€ä»¥å¦‚æœä½ èƒ½ç¡®å®šä¸¤è€…çš„å¯¹åº”ï¼Œä¸éœ€è¦æˆ‘ä»¬å†å»è·å–ã€‚è€Œä¸”ï¼Œä½¿ç”¨ä¸Šé¢æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æ¯ä¸€ä¸ªç‰ˆæœ¬å¯¹åº”çš„`dSYM`æ–‡ä»¶(å‡å¦‚ä½ æ²¡æœ‰åˆ é™¤çš„è¯)ã€‚

## æœ€å

æ„‰å¿«çš„æ”¹Bugå§ğŸ˜³

## Refrence
[Understanding and Analyzing Application Crash Reports](https://developer.apple.com/library/content/technotes/tn2151/_index.html)
[iOS é”™è¯¯å †æ ˆæŸ¥æ‰¾å´©æºƒåŸå› çš„æ–¹æ³•](http://bughd.com/doc/ioscrash)
[Xcode - There are no dSYMs available for download](http://stackoverflow.com/questions/35159244/xcode-there-are-no-dsyms-available-for-download)



