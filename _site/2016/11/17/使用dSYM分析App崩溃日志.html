<!DOCTYPE html>
<html>
<head><!-- post -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>使用dSYM分析App崩溃日志 - Stay True</title>
    <meta name="author"  content="Ju Liaoyuan">
    <meta name="description" content="使用dSYM分析App崩溃日志">
    <meta name="keywords"  content="iOS">
    <!-- Open Graph -->
    <meta property="og:title" content="使用dSYM分析App崩溃日志 - Stay True">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://localhost:4000/2016/11/17/%E4%BD%BF%E7%94%A8dSYM%E5%88%86%E6%9E%90App%E5%B4%A9%E6%BA%83%E6%97%A5%E5%BF%97.html">
    <meta property="og:description" content="iOS 搬砖，业余天文爱好者">
    <meta property="og:site_name" content="Stay True">
    <link rel="stylesheet" href="//cdn.staticfile.org/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href= "/assets/css/github-markdown.css" | prepend: site.baseurl >
    <link rel="stylesheet" href="/assets/css/styles/default.css" | prepend: site.baseurl>
    <link rel="stylesheet" href= "/assets/css/share.min.css"  | prepend: site.baseurl>
    <link rel="stylesheet" href= "/assets/css/app.min.css" | prepend: site.baseurl >

    <!-- Favicon -->
    <link rel="shortcut icon" href="/assets/img/favicon.ico">
</head>
<body>
    <!--[if lt IE 10]>
<div class="alert-danger" role="alert">你的浏览器实在太太太旧了，放学别走，升级完浏览器再说！<a target="_blank" class="alert-link" href="http://browsehappy.com">立即升级</a></div>
<![endif]-->
<input id="nm-switch" type="hidden" value="false">

<header class="g-header">
    <div class="g-logo">
        <a href="/"></a>
    </div>
    <i id="menu-toggle" class="iconfont icon-menu"></i>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">home</a></li>
            
            <li><a href="/tags.html">tags</a></li>
            
        </ul>
    </nav>
</header>

<header class="g-banner post-header post-pattern-circuitBoard bgcolor-default post-no-cover" data-theme="default">
    <div class="post-wrapper">
        <div class="post-tags">
             
            
            <a href="/tags#iOS" class="post-tag">iOS</a>
            
            
        </div>
        <h1>使用dSYM分析App崩溃日志</h1>
        <div class="post-meta">
            <span class="post-meta-item"><i class="iconfont icon-author"></i><a href="http://localhost:4000" target="_blank" rel="author">Ju Liaoyuan</a></></span>
            <time class="post-meta-item" datetime="16-11-17"><i class="iconfont icon-date"></i>18 Nov 2016</time>
        </div>
    </div>
    
</header>

<div class="post-content">
    
    <article class="markdown-body">
        <!--more-->

<h2 id="前言">前言</h2>
<p>我们在开发App过程中，因为连接到控制台，所以遇到问题会很容易找到问题代码。但是对于线上的App出现Crash的时候，我们不可能通过这种方式，也不现实，所以我们只能通过收集Crash信息，来解决Bug。而这种收集Crash信息并且分析定位到具体代码的第三方SDK很多。但是今天我们来自己实现一下。</p>

<!--more-->

<h2 id="收集-crash-信息">收集 Crash 信息</h2>
<p><code class="highlighter-rouge">Apple</code>提供了<code class="highlighter-rouge">NSException</code>类来帮助我们收集异常信息。</p>

<blockquote>
  <p>NSException is used to implement exception handling and contains information about an exception  — Apple Documentation.</p>
</blockquote>

<p><a href="https://developer.apple.com/reference/foundation/nsexception">点击这里</a>来查看官方文档具体内容。</p>

<p>我们的确可以通过<code class="highlighter-rouge">NSException</code>来收集信息，但是，我们怎么把这个信息保存下来，并且上传到我们后台服务器，收集起来呢。这就需要用到另一个函数:<code class="highlighter-rouge">NSUncaughtExceptionHandler</code></p>

<blockquote>
  <p>Sets the top-level error-handling function where you can perform last-minute logging before the program terminates.</p>
</blockquote>

<p>意思就是我们可以在App异常退出的之前有一分钟的时间来处理异常信息，利用这段时间，我们可以把Crash信息写入本地，也可以上传到服务器，但是考虑到网络阻塞原因，我们可能在这一分钟不能操作完毕，所以我们把上传放到下一次App启动时执行。</p>

<p>具体的代码如下：</p>

<pre><code class="language-ObjC">- (void)lyCarshLog {
    [self uploadExceptionLog];
    NSSetUncaughtExceptionHandler(&amp;catchExceptionLog);
}
- (void)uploadExceptionLog {
     if (log != nil) {
        // 在这里上传 Crash 信息，上传完毕后要记得清空。
     }
}
void catchExceptionLog(NSException *exception) {
    // 获取 Crash 信息
    NSArray *symbols = [exception callStackSymbols];
    NSString *reason = [exception reason];
    NSString *name = [exception name];
    NSDictionary *userInfo = [exception userInfo];
    //...
    
    /*另外，我们可能需要一些别的信息，比如说发生 Crash 的设备的系统版本，设备型号，App的版本号*/
    struct utsname systemInfo; // 需要导入`sys/utsname.h`头文件。
    uname(&amp;systemInfo);
    NSString *deviceString = [NSString stringWithCString:systemInfo.machine encoding:NSUTF8StringEncoding];
    NSDictionary *appInfo = [[NSBundle mainBundle] infoDictionary];
    NSString *appVersion = [appInfo objectForKey:@"CFBundleShortVersionString"];
    NSString *result = [NSString stringWithFormat:@"CarshReason = %@ \n name = %@ \n userInfo = %@ \n log = %@ \n systemVersion = %f \n deviceInfo = %@ \n appVersion = %@ ",reason,name,userInfo,symbols,[UIDevice currentDevice].systemVersion.floatValue,deviceString,appVersion];
    // 把 result 写入本地。
}

</code></pre>

<p><code class="highlighter-rouge">Crash</code>信息至此已经收集完毕，等待下次App启动的时候，我们把本地的Crash信息上传到服务器就OK了。</p>

<h2 id="处理-crash-信息---符号化fully-symbolicated">处理 Crash 信息 - 符号化(Fully Symbolicated)</h2>

<p>我们得到的信息可能如下(Partially Symbolicated)：</p>

<blockquote>
  <p>Tips: 堆栈跟踪是<code class="highlighter-rouge">自下而上</code>展示的，也就是最先调用的方法在最下面。</p>
</blockquote>

<p>每行信息中包含的信息：</p>

<p>其中：</p>

<ol>
  <li><code class="highlighter-rouge">Binary name</code>  表明代码所在<code class="highlighter-rouge">App</code>或者<code class="highlighter-rouge">Framework</code>的位置。比如：line 0 是在<code class="highlighter-rouge">CoreFoundation</code>中，line 3 在<code class="highlighter-rouge">CrashDemo</code>中…</li>
  <li><code class="highlighter-rouge">Address</code> 方法的内存地址。</li>
  <li><code class="highlighter-rouge">Class name</code> 当前的类名。</li>
  <li><code class="highlighter-rouge">Method name</code> 当前调用的方法名。</li>
  <li><code class="highlighter-rouge">Offset</code> 相对<code class="highlighter-rouge">加载地址/基地址(load address)</code>的偏移量。</li>
</ol>

<p>我们得到这个半符号化(Partially Symbolicated)的日志对我们分析Crash原因的帮助很有限，因为我们可能只能知道<code class="highlighter-rouge">__NSArrayI objectAtIndex:</code>调用出现了问题，但是不能定位到具体代码。所以我们要把它完全符号化(Fully Symbolicated)。</p>

<h3 id="dsym">dSYM</h3>

<p>我们需要借助<code class="highlighter-rouge">dSYM</code>来帮助我们完成符号化，对于<code class="highlighter-rouge">dSYM</code>文件的获取，我们可以通过多种方法，我这里只说一种:</p>

<p>先打开<code class="highlighter-rouge">Xcode</code>，<code class="highlighter-rouge">Windows</code>-&gt;<code class="highlighter-rouge">Organize</code>-&gt;找到对应的app包，然后<code class="highlighter-rouge">右键</code>-&gt;<code class="highlighter-rouge">Show in finder</code>,找到<code class="highlighter-rouge">appName. xcarchive </code>-&gt;<code class="highlighter-rouge">显示包内容</code>-&gt;<code class="highlighter-rouge">把dSYMs拷贝出来(或者就在里面操作)</code>。</p>

<h3 id="atos">atos</h3>

<blockquote>
  <p>The atos command converts numeric addresses to their symbolic equivalents</p>
</blockquote>

<p>我们使用<code class="highlighter-rouge">atos</code>命令来完成符号化，具体命令如下：
<code class="highlighter-rouge">$ atos -arch &lt;Binary Architecture&gt; -o &lt;Path to dSYM file&gt;/Contents/Resources/DWARF/&lt;binary image name&gt; -l &lt;load address&gt; &lt;address to symbolicate&gt;
</code>
其中:</p>
<ol>
  <li>Binary Architecture: <code class="highlighter-rouge">arm64</code>、<code class="highlighter-rouge">armv6</code>、<code class="highlighter-rouge">armv7</code> <code class="highlighter-rouge">armv7s</code> 根据自己的情况来写。</li>
  <li>Path to dSYM file: dSYM文件的路径。</li>
  <li>binary image name: 你工程的名字。</li>
  <li>load address: 基地址，如果我们的崩溃日志中没有这个信息(比如上面的Crash信息中就没有包含)，就需要我们手动去计算这个<code class="highlighter-rouge">load address</code>:<code class="highlighter-rouge">laod address = address to symbolicate - offset</code>,比如：<code class="highlighter-rouge">0x0000000102838119</code>转化为十进制为<code class="highlighter-rouge">4337139993</code>,再减去偏移量<code class="highlighter-rouge">265</code>,为<code class="highlighter-rouge">4337139728</code>,在转化为十六进制<code class="highlighter-rouge">0x0000000102838010</code></li>
  <li>address to symbolicate:当前方法的内存地址。</li>
</ol>

<p>所以，上图为例(图被黑心图床吃了。。。)：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd CrashDemo/dSYMs
$ atos -arch arm64 -o CrashDemo.app.dSYM/Contents/Resources/DWARF/CrashDemo -l  0x0000000102838010 0x0000000102838119
</code></pre></div></div>

<p>这时命令就会输出已经符号化过的信息:
<code class="highlighter-rouge">-[ViewController viewDidLoad] (in CrashDemo) (ViewController.m:45)</code></p>

<p>其中<code class="highlighter-rouge">45</code>就是问题代码在<code class="highlighter-rouge">ViewController.m</code>中的具体位置。</p>

<p>其实<code class="highlighter-rouge">符号化</code>的过程有多种方式，你可以参考<a href="https://developer.apple.com/library/content/technotes/tn2151/_index.html">Apple文档</a>,对于其中<code class="highlighter-rouge">UUID</code>，只是为了我们找到App对应版本的<code class="highlighter-rouge">dSYM</code>文件，所以如果你能确定两者的对应，不需要我们再去获取。而且，使用上面方法，我们可以找到每一个版本对应的<code class="highlighter-rouge">dSYM</code>文件(假如你没有删除的话)。</p>

<h2 id="最后">最后</h2>

<p>愉快的改Bug吧😳</p>

<h2 id="refrence">Refrence</h2>
<p><a href="https://developer.apple.com/library/content/technotes/tn2151/_index.html">Understanding and Analyzing Application Crash Reports</a>
<a href="http://bughd.com/doc/ioscrash">iOS 错误堆栈查找崩溃原因的方法</a>
<a href="http://stackoverflow.com/questions/35159244/xcode-there-are-no-dsyms-available-for-download">Xcode - There are no dSYMs available for download</a></p>


    </article>
    
    <div class="social-share-wrapper">
        <div class="social-share"></div>
    </div>
    
</div>

<section class="author-detail">
    <section class="post-footer-item author-card">
        <div class="avatar">
            <img src="/assets/img/profile.png" alt="">
        </div>
        <div class="author-name" rel="author">Ju Liaoyuan</div>
        <div class="bio">
            <p>iOS 搬砖，业余天文爱好者</p>
        </div>
        
        <ul class="sns-links">
            
            <li>
                <a href="//weibo.com/u/2738809475" target="_blank">
                    <i class="iconfont icon-weibo"></i>
                </a>
            </li>
            
            <li>
                <a href="//juejin.im/user/5872f9822f301e0057490c89" target="_blank">
                    <i class="iconfont icon-juejin"></i>
                </a>
            </li>
            
            <li>
                <a href="//github.com/liaoyuanng" target="_blank">
                    <i class="iconfont icon-github"></i>
                </a>
            </li>
            
            <li>
                <a href="//jianshu.com/u/f386d4a61d33" target="_blank">
                    <i class="iconfont icon-jianshu"></i>
                </a>
            </li>
            
            <li>
                <a href="mailto:liaoyuan@imliaoyuan.com" target="_blank">
                    <i class="iconfont icon-email"></i>
                </a>
            </li>
            
        </ul>
        
    </section>
    <section class="post-footer-item read-next">
        
        <div class="read-next-item">
            <a href="/2017/01/01/Hi,2017.html" class="read-next-link"></a>
            <section>
                <span>Hi，2017</span>
                <p>2016，已从睡梦中走过，2017，更多的未知和挑战，等待着我。</p>
            </section>
            
            <div class="filter"></div>
            <img src="https://leo-1253441258.cos.ap-shanghai.myqcloud.com/blog/shanghai.jpg" alt="">
            
        </div>
        
         
        <div class="read-next-item">
            <a href="/2016/11/09/%E4%B8%80%E5%BC%A0%E5%9B%BE%E7%90%86%E8%A7%A3%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90.html" class="read-next-link"></a>
            <section>
                <span>一张图正确理解内存对齐</span>
                <p></p>
            </section>
            
        </div>
        
    </section>
    
</section>

<footer class="g-footer">
    <section>Stay True © 2018</section>
    <section>Powered by <a href="//jekyllrb.com">Jekyll</a> | <a href="https://github.com/liaoyuanng/StayTrue">Theme StayTrue</a>
    <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p></section>
</footer>

<script src="/assets/js/social-share.min.js"></script>
<script>
    socialShare('.social-share', {
        sites: ['wechat','weibo','twitter','facebook'],
        wechatQrcodeTitle: "分享到微信朋友圈",
        wechatQrcodeHelper: '<p>扫码后分享😘</p>'
    });
</script>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
/*写入自己的disqus信息*/
s.src = '';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
<script src="/assets/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/assets/js/index.min.js"></script>
</body>
</html>