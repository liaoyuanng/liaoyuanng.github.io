<!DOCTYPE html>
<html>
<head><!-- post -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS10新特性 - 通知 - Stay True</title>
    <meta name="author"  content="Ju Liaoyuan">
    <meta name="description" content="iOS10新特性 - 通知">
    <meta name="keywords"  content="iOS">
    <!-- Open Graph -->
    <meta property="og:title" content="iOS10新特性 - 通知 - Stay True">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://localhost:4000/2016/09/24/iOS10%E6%96%B0%E7%89%B9%E6%80%A7-%E9%80%9A%E7%9F%A5.html">
    <meta property="og:description" content="iOS 搬砖，业余天文爱好者">
    <meta property="og:site_name" content="Stay True">
    <link rel="stylesheet" href="//cdn.staticfile.org/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href= "/assets/css/github-markdown.css" | prepend: site.baseurl >
    <link rel="stylesheet" href="/assets/css/styles/default.css" | prepend: site.baseurl>
    <link rel="stylesheet" href= "/assets/css/share.min.css"  | prepend: site.baseurl>
    <link rel="stylesheet" href= "/assets/css/app.min.css" | prepend: site.baseurl >

    <!-- Favicon -->
    <link rel="shortcut icon" href="/assets/img/favicon.ico">
</head>
<body>
    <!--[if lt IE 10]>
<div class="alert-danger" role="alert">你的浏览器实在太太太旧了，放学别走，升级完浏览器再说！<a target="_blank" class="alert-link" href="http://browsehappy.com">立即升级</a></div>
<![endif]-->
<input id="nm-switch" type="hidden" value="false">

<header class="g-header">
    <div class="g-logo">
        <a href="/"></a>
    </div>
    <i id="menu-toggle" class="iconfont icon-menu"></i>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">home</a></li>
            
            <li><a href="/tags.html">tags</a></li>
            
        </ul>
    </nav>
</header>

<header class="g-banner post-header post-pattern-circuitBoard bgcolor-default " data-theme="default">
    <div class="post-wrapper">
        <div class="post-tags">
             
            
            <a href="/tags#iOS" class="post-tag">iOS</a>
            
            
        </div>
        <h1>iOS10新特性 - 通知</h1>
        <div class="post-meta">
            <span class="post-meta-item"><i class="iconfont icon-author"></i><a href="http://localhost:4000" target="_blank" rel="author">Ju Liaoyuan</a></></span>
            <time class="post-meta-item" datetime="16-09-24"><i class="iconfont icon-date"></i>25 Sep 2016</time>
        </div>
    </div>
    
    <div class="filter"></div>
    <div class="post-cover" style="background: url('https://leo-1253441258.cos.ap-shanghai.myqcloud.com/blog/ios10.png') center no-repeat; background-size: cover;">
    
</header>

<div class="post-content">
    
    <article class="markdown-body">
        <p>iOS 10 中，苹果对通知进行了较大的更新。又有的玩了。</p>

<!--more-->
<p>我们来一步步探索下iOS 10 中，通知那些事。</p>

<p><em>这里不会讲通知的原理，证书的创建，假设你已经知道前面的流程</em></p>

<p>先下载<a href="https://github.com/Stu-JuLiaoY/iOS10NewNotification">Demo</a>,阅读更佳。</p>

<h2 id="注册通知">注册通知</h2>
<p>在iOS 10 之前，我们注册通知会像下面一样：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 注册远程通知
UIUserNotificationSettings *notiSettings = [UIUserNotificationSettings settingsForTypes:UIUserNotificationTypeBadge | UIUserNotificationTypeAlert | UIRemoteNotificationTypeSound categories:nil];
[application registerUserNotificationSettings:notiSettings];
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 注册本地通知
UILocalNotification *localNotification = [[UILocalNotification alloc] init];
// something setting.... BlaBla~
[application scheduleLocalNotification:localNotification];
</code></pre></div></div>
<p>然后在<code class="highlighter-rouge">didRegisterForRemoteNotificationsWithDeviceToken：</code>上传Token，在<code class="highlighter-rouge">didReceiveRemoteNotification:</code>里面处理相关逻辑。而在iOS 10 里面，API得到了统一。注册通知如下（记得导入系统头文件：<code class="highlighter-rouge">&lt;UserNotifications/UserNotifications.h&gt;</code>）：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 在 didFinishLaunchingWithOptions：
UNUserNotificationCenter *notification = [UNUserNotificationCenter currentNotificationCenter];
notification.delegate = self;
[notification requestAuthorizationWithOptions:UNAuthorizationOptionBadge | UNAuthorizationOptionAlert | UNAuthorizationOptionSound completionHandler:^(BOOL granted, NSError * _Nullable error) { 
    }];
</code></pre></div></div>
<h2 id="创建通知内容">创建通知内容</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UNMutableNotificationContent *content = [UNMutableNotificationContent new];
content.badge = @1;
content.title = @"liaoyuan test title";
content.body = @"liaoyuan test body";
content.subtitle = @"liaoyuan test subtitle";
content.categoryIdentifier = categoryIdentifier; // 很重要
content.launchImageName = @"launchImage.png";
content.sound = [UNNotificationSound defaultSound];
content.threadIdentifier = threadIdentifier;
content.userInfo = @{@"name":@"liaoyuan"};  
UNTimeIntervalNotificationTrigger *trigger = [UNTimeIntervalNotificationTrigger triggerWithTimeInterval:3.f repeats:NO];
NSURL *url = [[NSBundle mainBundle] URLForResource:@"1" withExtension:@"jpg"];
NSError *error = nil;
NSURL *url = [[NSBundle mainBundle] URLForResource:@"1" withExtension:@"png"];
    NSDictionary *options = @{UNNotificationAttachmentOptionsTypeHintKey:(NSString *)kUTTypeImage};
    UNNotificationAttachment *attachment = [UNNotificationAttachment attachmentWithIdentifier:attachmentIdentifie URL:url options:options error:nil];content.attachments = @[attachment];
UNNotificationRequest *request = [UNNotificationRequest requestWithIdentifier:requestIdentifier content:content trigger:trigger];
    self.request = request;
</code></pre></div></div>

<p>其中：</p>
<h3 id="categoryidentifier">CategoryIdentifier</h3>
<p><code class="highlighter-rouge">categoryIdentifier</code>是用来给通知添加action的标志符，在后面有介绍。</p>

<h3 id="unnotificationtrigger">UNNotificationTrigger</h3>
<p><code class="highlighter-rouge">UNTimeIntervalNotificationTrigger</code> 是iOS 10 中新加入的API。是通知的触发器。iOS 10 中一共有三个类似的API，分别是：
<code class="highlighter-rouge">UNTimeIntervalNotificationTrigger</code>,	// 一段时间之后发送通知
<code class="highlighter-rouge">UNCalendarNotificationTrigger</code>,		// 指定日期发送通知
<code class="highlighter-rouge">UNLocationNotificationTrigger</code>。		// 进入或离开某一区域发送通知</p>

<p>Tip:
如果要设置重复提醒的话，时间间隔必须大于60S，要不然会崩溃。</p>

<h3 id="unnotificationattachment">UNNotificationAttachment</h3>
<p><code class="highlighter-rouge">UNNotificationAttachment</code>是一个给通知添加附件的API，我这里给它添加了一张图片，注意，初始化方法里面的<code class="highlighter-rouge">URL</code>必须是一个文件的路径。</p>

<blockquote>
  <p>URL must be a file URL. Returns nil if the data at URL is not supported. – Apple</p>
</blockquote>

<p>其中的<code class="highlighter-rouge">options</code>,我们点进<code class="highlighter-rouge">UNNotificationAttachment</code>头文件，发现在头文件下面有四个<code class="highlighter-rouge">ertern key</code>
<img src="https://leo-1253441258.cos.ap-shanghai.myqcloud.com/blog/keys.png" alt="keys" /></p>

<p>分别指定<code class="highlighter-rouge">Attachment</code>的:<em>类型</em>，<em>是否隐藏</em>，<em>缩略图的范围（CGRect）</em>，<em>如果Tepy是Movie，则指定时间对应的图像来作为缩略图</em>。</p>

<p>所以，我们可以根据需求，来指定缩略图的属性。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NSDictionary *options = @{UNNotificationAttachmentOptionsTypeHintKey:(NSString *)kUTTypeGIF,
                              UNNotificationAttachmentOptionsThumbnailHiddenKey:@NO,
                              UNNotificationAttachmentOptionsThumbnailClippingRectKey:NSStringFromCGRect(CGRectMake(0, 0, 0.5, 0.5))};
</code></pre></div></div>
<p>Tips:</p>

<ol>
  <li>需要注意的是，对于<code class="highlighter-rouge">kUTTypeGIF</code>,我们需要导图头文件：<code class="highlighter-rouge">&lt;MobileCoreServices/MobileCoreServices.h&gt;</code>才能使用<a href="http://stackoverflow.com/questions/24471647/use-of-undeclared-identifier-even-though-framework-linked-and-header-file-impo">Use of undeclared identifier</a>;如果不设置，系统会根据后缀名自动推断文件类型。</li>
  <li>UNNotificationAttachmentOptionsThumbnailClippingRectKey 貌似只对静态图片有效，我在实验的时候，发现GIF的缩略图不能指定范围。如果不设置，默认是居中的。</li>
</ol>

<h2 id="创建通知请求">创建通知请求</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UNNotificationRequest *request = [UNNotificationRequest requestWithIdentifier:requestIdentifier content:content trigger:trigger];
</code></pre></div></div>

<h2 id="发送通知">发送通知</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UNUserNotificationCenter *notification = [UNUserNotificationCenter currentNotificationCenter];
    [notification addNotificationRequest:request withCompletionHandler:^(NSError * _Nullable error) {
}];
</code></pre></div></div>

<p>至此，一个完整的推送通知已经创建完毕，并且已经发送。</p>

<h2 id="处理通知">处理通知</h2>

<p>在iOS 10 之前，如果我们的App在前台，我们收到的通知是无法展示的，我们通常会在<code class="highlighter-rouge">didReceiveRemoteNotification</code>里面做一些处理。但是，在iOS 10 ，这件事变得无比简单。我们只需要在<code class="highlighter-rouge">userNotificationCenter: willPresentNotification: withCompletionHandler:</code>里面，写上我们想要展示的，比如：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>completionHandler(UNNotificationPresentationOptionBadge | UNNotificationPresentationOptionAlert | UNNotificationPresentationOptionSound);
</code></pre></div></div>
<p>这样，我们就可以在前台也展示通知了。需要注意的是，这个是<code class="highlighter-rouge">UNUserNotificationCenterDelegate</code>的代理方法，我们要记得建立代理关系，并且继承协议。</p>

<p>当用户点击通知进入App的时候，会调用<code class="highlighter-rouge">userNotificationCenter: didReceiveNotificationResponse: withCompletionHandler:</code>方法。我们在这个方法里面可以轻松获取到通知的所有内容：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>response.notification.request.content.userInfo;
</code></pre></div></div>

<h2 id="更新删除通知">更新、删除通知</h2>

<p>这是iOS 10 通知的一大新特性。我们可以很方便的通过<code class="highlighter-rouge">requestIdentifier</code>更新、删除（已经展示和未展示）通知.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 更新通知
UNMutableNotificationContent *content = [UNMutableNotificationContent new];
content.badge = @1;
content.title = @"liaoyuan update title";
content.body = @"liaoyuan update body";
content.subtitle = @"liaoyuan update subtitle";
content.categoryIdentifier = categoryIdentifier;
content.launchImageName = @"launchImage.png";
content.sound = [UNNotificationSound defaultSound];
content.threadIdentifier = threadIdentifier;
content.userInfo = @{@"name":@"liaoyuan"}; 

UNTimeIntervalNotificationTrigger *trigger = [UNTimeIntervalNotificationTrigger triggerWithTimeInterval:3.f repeats:NO];

NSURL *url = [[NSBundle mainBundle] URLForResource:@"launchImage" withExtension:@"png"];
NSError *error = nil;
UNNotificationAttachment *attachment = [UNNotificationAttachment attachmentWithIdentifier:attachmentIdentifie URL:url options:nil error:&amp;error];

content.attachments = @[attachment];    

UNNotificationRequest *newRequest = [UNNotificationRequest requestWithIdentifier:requestIdentifier content:content trigger:trigger];
UNUserNotificationCenter *newNotification = [UNUserNotificationCenter currentNotificationCenter];
[newNotification addNotificationRequest:newRequest withCompletionHandler:^(NSError * _Nullable error) {        
}];
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 移除还未展示的通知
UNUserNotificationCenter *notification = [UNUserNotificationCenter currentNotificationCenter];
    [notification removePendingNotificationRequestsWithIdentifiers:@[requestIdentifier]];
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 移除已经展示的通知(通知栏清除掉该通知)
UNUserNotificationCenter *notification = [UNUserNotificationCenter currentNotificationCenter];
    [notification removeDeliveredNotificationsWithIdentifiers:@[requestIdentifier]];
</code></pre></div></div>

<p>Tips： 我们现在还不能像本地推送一样，取消远程推送，但是我们可以这样做：</p>

<blockquote>
  <p>现在如果想要消除一个远程推送，可以选择使用后台静默推送的方式来从本地发起一个删除通知的调用        – 引自的喵神的<a href="https://onevcat.com/2016/08/notification/">活久见的重构 - iOS 10 UserNotifications 框架解析</a>.</p>
</blockquote>

<h2 id="给通知添加action-button">给通知添加Action Button</h2>
<p>这个并不是iOS 10 的新特性，只是介绍下在新的API下，该怎么用。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> // 添加Action
    UNNotificationAction *sayHelloAction = [UNNotificationAction actionWithIdentifier:JLYNotificationSayHelloID title:@"你好" options:UNNotificationActionOptionForeground];
    UNTextInputNotificationAction *textInput = [UNTextInputNotificationAction actionWithIdentifier:JLYNotificationInputID title:@"评论一个" options:UNNotificationActionOptionForeground textInputButtonTitle:@"评论" textInputPlaceholder:@"评论一个"];
    
    UNNotificationAction *cancelAction = [UNNotificationAction actionWithIdentifier:JLYNotificationCancelID title:@"取消" options:UNNotificationActionOptionDestructive];
    
    UNNotificationCategory *notiCategory = [UNNotificationCategory categoryWithIdentifier:categoryIdentifier actions:@[sayHelloAction,textInput,cancelAction] intentIdentifiers:@[] options:UNNotificationCategoryOptionCustomDismissAction];
    
    UNUserNotificationCenter *notification = [UNUserNotificationCenter currentNotificationCenter];
    NSSet *set = [[NSSet alloc] initWithObjects:notiCategory, nil];
    [notification setNotificationCategories:set];
</code></pre></div></div>

<p>我们可以在 <code class="highlighter-rouge">didReceiveNotificationResponse</code> 里面通过 <code class="highlighter-rouge">ActionIdentifier</code> 判断用户点击了哪个按钮。做出对应的处理。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> NSString *categoryIdentifier = response.actionIdentifier;
    if ([categoryIdentifier isEqualToString:JLYNotificationInputID]) {
        
        UNTextInputNotificationResponse *action = (UNTextInputNotificationResponse *)response;
        [PEEAlertView showAlertWithTitle:@"输入的内容为:" message:action.userText actionTitle:@"确定"];
    }
    if ([categoryIdentifier isEqualToString:JLYNotificationSayHelloID]) {
        [PEEAlertView showAlertWithTitle:@"Hello" message:@"" actionTitle:@"OK"];
    }
    if ([categoryIdentifier isEqualToString:JLYNotificationCancelID]) {
        NSLog(@"cancel");
    }

</code></pre></div></div>

<h2 id="自定义notification-ui">自定义Notification UI</h2>
<p>创建<code class="highlighter-rouge">Notification Content</code>: File -&gt; New -&gt; Target -&gt; Notification Content.
然后，就会看到系统为我们自动生成了四个文件：
<em>NotificationViewController.h</em>
<em>NotificationViewController.m</em>
<em>MainInterface.storyboard</em>
<em>info.plist</em></p>

<p>首先，我们要在info.plist里面找到<code class="highlighter-rouge">NSExtension</code>,里面有个<code class="highlighter-rouge">NSExtensionAttributes</code>,类型为字典，然后下一级，找到<code class="highlighter-rouge">UNNotificationExtensionCategory</code>,类型为String，把这个设置为和<code class="highlighter-rouge">categoryIdentifier</code>一致。<code class="highlighter-rouge">UNNotificationExtensionInitialContentSizeRatio</code>这个是自定义视图的大小比例。根据需要去设置。</p>

<p>然后，再次发送通知，就可以看到效果了。</p>

<h2 id="notificationservice-extension">NotificationService Extension</h2>
<p>仅支持远程推送，挖个坑，待填。</p>

<h2 id="refrence">Refrence</h2>

<p>大量参考了喵神的<a href="https://onevcat.com/2016/08/notification/">活久见的重构 - iOS 10 UserNotifications 框架解析</a>.</p>

<h2 id="demo">Demo</h2>

<p>本文的Demo可以在<a href="https://github.com/Stu-JuLiaoY/iOS10NewNotification">这里</a>下载。</p>

<h2 id="总结">总结：</h2>
<p>感觉iOS 10 的通知推送功能实在是太强大了，可挖掘的很深，就看各个产品经理怎么玩了。仅仅一个小Demo，就让我感觉以后的App推送会玩出花来，比如：视频类网站，可以推送小视频，而不在是枯燥的文字；音乐类App，每日推荐也可以选择一段音乐来激活用户。最最最重要的是，<strong>程序猿又有了新的表白神器，哈哈哈哈哈哈</strong>。睡觉zZ~</p>


    </article>
    
    <div class="social-share-wrapper">
        <div class="social-share"></div>
    </div>
    
</div>

<section class="author-detail">
    <section class="post-footer-item author-card">
        <div class="avatar">
            <img src="/assets/img/profile.png" alt="">
        </div>
        <div class="author-name" rel="author">Ju Liaoyuan</div>
        <div class="bio">
            <p>iOS 搬砖，业余天文爱好者</p>
        </div>
        
        <ul class="sns-links">
            
            <li>
                <a href="//weibo.com/u/2738809475" target="_blank">
                    <i class="iconfont icon-weibo"></i>
                </a>
            </li>
            
            <li>
                <a href="//juejin.im/user/5872f9822f301e0057490c89" target="_blank">
                    <i class="iconfont icon-juejin"></i>
                </a>
            </li>
            
            <li>
                <a href="//github.com/liaoyuanng" target="_blank">
                    <i class="iconfont icon-github"></i>
                </a>
            </li>
            
            <li>
                <a href="//jianshu.com/u/f386d4a61d33" target="_blank">
                    <i class="iconfont icon-jianshu"></i>
                </a>
            </li>
            
            <li>
                <a href="mailto:liaoyuan@imliaoyuan.com" target="_blank">
                    <i class="iconfont icon-email"></i>
                </a>
            </li>
            
        </ul>
        
    </section>
    <section class="post-footer-item read-next">
        
        <div class="read-next-item">
            <a href="/2016/10/27/%E8%AE%B0%E4%B8%80%E6%AC%A1Runtime%E7%9A%84%E5%B7%A7%E7%94%A8.html" class="read-next-link"></a>
            <section>
                <span>记一次Runtime的巧用</span>
                <p></p>
            </section>
            
        </div>
        
         
        <div class="read-next-item">
            <a href="/2016/08/30/%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E6%B7%BB%E5%8A%A0child_view_controller.html" class="read-next-link"></a>
            <section>
                <span>如何正确添加Child View Controller</span>
                <p>这是一个什么问题？</p>
            </section>
            
        </div>
        
    </section>
    
</section>

<footer class="g-footer">
    <section>Stay True © 2018</section>
    <section>Powered by <a href="//jekyllrb.com">Jekyll</a> | <a href="https://github.com/liaoyuanng/StayTrue">Theme StayTrue</a>
    <p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></p></section>
</footer>

<script src="/assets/js/social-share.min.js"></script>
<script>
    socialShare('.social-share', {
        sites: ['wechat','weibo','twitter','facebook'],
        wechatQrcodeTitle: "分享到微信朋友圈",
        wechatQrcodeHelper: '<p>扫码后分享😘</p>'
    });
</script>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
/*写入自己的disqus信息*/
s.src = '';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
<script src="/assets/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/assets/js/index.min.js"></script>
</body>
</html>